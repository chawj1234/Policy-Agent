# ==================================================
# Imports
# ==================================================
from typing import Optional

# ==================================================
# Embedded Sample Policy Text (for demo / fallback)
# ==================================================

SAMPLE_POLICY_TEXT = """
출처: 기획재정부 「2026년부터 이렇게 달라집니다」 (2025.12.29 배포)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[정책 1] 청년미래적금
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
시행일: 2026년 상반기
대상: 만 19~34세 청년
내용:
- 장기 가입 부담을 줄이고 정부기여금 비율을 높인 새로운 청년 자산형성 상품
- 기존 청년도약계좌 대비 가입 기간 단축 및 정부 매칭 비율 상향
신청 방법: 시중은행 앱 또는 온라인 신청 (상세 일정 추후 공고)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[정책 2] 취업 후 상환 학자금 대출(ICL) 확대
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
시행일: 2026년 1학기부터
대상: 모든 대학(원)생 (소득구간 무관)
내용:
- 기존: 소득 8구간 이하만 신청 가능
- 변경: 소득구간에 관계없이 모든 대학(원)생이 등록금 대출 신청 가능
신청 방법: 한국장학재단 홈페이지

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[정책 3] K-패스 청년 환급율 상향
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
시행일: 2026년
대상: 만 19~34세 청년, 65세 이상 어르신
내용:
- 청년/어르신 K-패스 환급율: 기존 20% → 30%로 상향
- 월 지출한도 (수도권 기준):
  · 일반국민: 월 6.2만원
  · 청년/어르신/2자녀: 월 5.5만원
  · 3자녀 이상/저소득: 월 4.5만원
신청 방법: K-패스 앱 또는 카드사 앱에서 신청

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[정책 4] 중소기업 직장인 든든한 한끼 지원
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
시행일: 2026년
대상: 중소기업 직장인 (5.4만명 대상)
내용:
- 아침밥: 산업단지 입주기업 근로자에게 1,000원에 아침식사 제공
- 점심밥: 점심값 일부(20%, 월 4만원 한도) 지원
신청 방법: 소속 기업 통해 신청 (산단별 상세 안내 예정)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[정책 5] 모두의 카드 (대중교통비 환급)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
시행일: 2026년
대상: 전 국민
내용:
- 기준금액을 초과 지출한 대중교통비 전액 환급
- K-패스와 연계하여 교통비 부담 경감
신청 방법: 모두의 카드 발급 후 자동 적용

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[정책 6] 보육수당 비과세 한도 확대 (자녀 있는 근로자)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
시행일: 2026.1.1
대상: 6세 이하 자녀를 둔 근로자
내용:
- 기존: 근로자 1인당 월 20만원 비과세
- 변경: 자녀 1인당 월 20만원 비과세 (다자녀 혜택 확대)
- 신용카드 소득공제 한도도 자녀 1인당 50만원씩 상향 (최대 100만원)

유의사항:
- 각 정책별 세부 자격요건 및 신청 기간은 정부24 또는 해당 기관 공고 확인 필요
- 중복 수혜 제한이 있을 수 있으므로 사전 확인 권장
""".strip()


# ==================================================
# Solar Planner Prompt Template
# ==================================================

SOLAR_PLANNER_TEMPLATE = """
역할:
너는 정부 정책 문서를 읽고, 이를 개인의 상황에 맞는 **행동 가능한 선택지**로 변환하는 AI Agent 오케스트레이터다.
너의 목적은 정보를 설명하는 것이 아니라, 사용자가 **다음에 무엇을 해야 할지 결정하도록 돕는 것**이다.

핵심 원칙:
- 단순 요약 금지 (정책 나열, 설명 위주의 답변 금지)
- 행동 중심 사고 유지
- 판단 → 선택지 → 결과 예측 → 행동 → 피드백 질문의 흐름을 반드시 따른다
- 사용자의 현재 상황을 기준으로 현실적으로 실행 가능한 내용만 제안한다

출력 규칙:
- 아래 5개 섹션 헤더를 반드시 모두 포함한다
- 수치를 제시할 때는 정확한 최신 기준을 확인해야 한다고 말하고, 단정 수치 대신 ‘확인 필요’로 표현하라.
- [판단 요약]의 첫 문장에는 반드시 판단 대상이 되는 정책명을 명시하여, 사용자가 어떤 정책에 대한 설명인지 즉시 알 수 있도록 한다
- 각 섹션은 구체적이고 명확해야 하며, 추상적인 표현을 피한다
- 정보가 부족한 경우, 이를 숨기지 말고 [추가 질문]에서 명확히 질문한다
- 사용자가 제공하지 않은 정보(가구원수, 연도 기준, 소득 판정 등)는 확정 표현(완전히 일치/확실) 대신 ‘가능성/확인 필요’로 표현하라.
- [추가 질문]에는 아직 답을 모르는 정보만 포함하고, 이미 제공된 정보는 다시 묻지 않는다
- 오타/띄어쓰기 오류 없이 작성
- 정책명/지역명/용어는 원문 그대로 유지


사용자 프로필:
{profile}

정책 문서 내용:
{policy_text}

{agent_plan}

{answered_fields}

출력 형식 (형식 유지 필수):
[판단 요약]
- 이 정책이 사용자에게 왜 중요한지 한 단락으로 설명

[선택지]
- 사용자가 선택할 수 있는 행동 경로를 2~3가지 제시

[시뮬레이션]
- 각 선택지를 따를 경우 예상되는 결과를 간단히 비교

[추천 행동]
- 현재 사용자에게 가장 합리적인 다음 행동을 단계별로 제시

[추가 질문]
- 판단을 더 정확히 하기 위해 필요한 정보 질문 (있을 경우)
""".strip()


def build_solar_prompt(
    profile: str,
    policy_text: str,
    agent_plan: Optional[str] = None,
    answered_fields: Optional[str] = None,
) -> str:
    """
    Build a structured planner prompt for Solar.
    The prompt is designed to force agentic (plan-and-act) behavior,
    not summarization.
    """

    return SOLAR_PLANNER_TEMPLATE.format(
        profile=profile,
        policy_text=policy_text,
        agent_plan=_format_agent_plan(agent_plan),
        answered_fields=_format_answered_fields(answered_fields),
    )


SOLAR_PLAN_TEMPLATE = """
역할:
너는 정책 문서와 사용자 프로필을 분석해 **판단에 필요한 정보**를 구조화한다.
최종 답변을 만들지 말고, 반드시 JSON만 출력한다.

목표:
- 확실한 조건과 불확실한 조건을 분리한다
- 부족한 정보는 질문으로 정리한다
- 추천 행동 후보를 리스트업한다

사용자 프로필:
{profile}

정책 문서 내용:
{policy_text}

출력 형식 (JSON만 출력):
{{
  "certain_conditions": ["..."],
  "uncertain_conditions": ["..."],
  "questions": [
    {{"field": "나이", "question": "만 나이가 어떻게 되나요?"}},
    {{"field": "거주지", "question": "현재 거주 지역이 수도권인가요?"}}
  ],
  "action_candidates": ["..."]
}}
""".strip()


def build_plan_prompt(profile: str, policy_text: str) -> str:
    """
    Build a plan prompt for Solar to output JSON-only planning metadata.
    """
    return SOLAR_PLAN_TEMPLATE.format(
        profile=profile,
        policy_text=policy_text,
    )


def _format_agent_plan(agent_plan: Optional[str]) -> str:
    if not agent_plan:
        return ""
    return f"에이전트 계획 결과:\n{agent_plan}"


def _format_answered_fields(answered_fields: Optional[str]) -> str:
    if not answered_fields:
        return ""
    return f"이미 제공된 답변:\n{answered_fields}"
